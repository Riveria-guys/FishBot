import telebot
import random
import psycopg2
from psycopg2 import OperationalError
import os
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞ .env
load_dotenv()

DB_URL = os.getenv("DATABASE_URL")

# -----------------------------------------------------------------------------------

def connect_db():
    """–°–æ–∑–¥–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —á–µ—Ä–µ–∑ —Å—Ç—Ä–æ–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏ –∫—É—Ä—Å–æ—Ä."""
    try:
        conn = psycopg2.connect(DB_URL)  # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–∞–ø—Ä—è–º—É—é
        cursor = conn.cursor()
        print("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —É—Å–ø–µ—à–Ω–æ")
        return conn, cursor
    except OperationalError as e:
        print(f"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {e}")
        return None, None
    

def close_db(conn, cursor):
    """–ó–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î."""
    if cursor:
        cursor.close()
    if conn:
        conn.close()
        print("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–∞
TOKEN = os.getenv("BOT_TOKEN")
bot = telebot.TeleBot(TOKEN)

#–ó–¥–µ—Å—å –±—ã–ª –ú–∞–∫—Å–∏–º
#–ó–¥–µ—Å—å –±—ã–ª –ñ–µ–Ω—è
#–ó–¥–µ—Å—å –±—ã–ª –î–µ–Ω–∏—Å
#–ó–¥–µ—Å—å –±—ã–ª –õ—ë–≤–∞
#–ó–¥–µ—Å—å –±—ã–ª –ö–æ–ª—è

# –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –≤–Ω—É—Ç—Ä–∏ –±–æ—Ç–∞
bot.set_my_commands([
    telebot.types.BotCommand("msp", "–ú–∞–≥–∏—á–µ—Å–∫–∏–π —à–∞—Ä"),
    telebot.types.BotCommand("start", "–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"),
    telebot.types.BotCommand("help", "–°–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥"),
    telebot.types.BotCommand("finnish", "–§–∏–Ω—Å–∫–∏–µ —Ñ—Ä–∞–∑—ã"),
])



# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
@bot.message_handler(commands=['start'])
def send_welcome(message):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é."""
    bot.reply_to(message, "–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –±–æ—Ç. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?")


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help
@bot.message_handler(commands=['help'])
def send_help(message):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é."""
    bot.reply_to(message, "–¢–µ–±–µ —Ç—É—Ç –Ω–∏–∫—Ç–æ –Ω–µ –ø–æ–º–æ–∂–µ—Ç, —Å–∞–º —Ä–∞–∑–±–∏—Ä–∞–π—Å—è.\n–í–æ—Ç —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥: \n/start - —Å—Ç–∞—Ä—Ç—É–µ–º –±–æ—Ç–∞\n/help - —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥\n/msp - –º–∞–≥–∏—á–µ—Å–∫–∏–π —à–∞—Ä")


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /finnish
@bot.message_handler(commands=['finnish'])
def finish_phrases(message):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é."""
    conn, cursor = connect_db()
    if conn:
        cursor.execute("SELECT finnish FROM finish_phrases ORDER BY RANDOM() LIMIT 1;")

    bot.reply_to(message, cursor.fetchall())
    
    close_db(conn, cursor)


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥s /msp (Magic Sphere)
@bot.message_handler(commands=['msp'])
def magic_sphere(message):
    """–í–æ–ª—à–µ–±–Ω—ã–π —à–∞—Ä"""
    answers = [
        "–ë–µ—Å—Å–ø–æ—Ä–Ω–æ",
        "–ü—Ä–µ–¥—Ä–µ—à–µ–Ω–æ",
        "–ù–∏–∫–∞–∫–∏—Ö —Å–æ–º–Ω–µ–Ω–∏–π",
        "–ú–æ–∂–µ—à—å –±—ã—Ç—å —É–≤–µ—Ä–µ–Ω –≤ —ç—Ç–æ–º",
        "–ú–Ω–µ –∫–∞–∂–µ—Ç—Å—è ‚Äî –¥–∞",
        "–ù–µ—Ç",
        "–ü–æ –º–æ–∏–º –¥–∞–Ω–Ω—ã–º ‚Äî –Ω–µ—Ç",
        "–í–µ—Å—å–º–∞ —Å–æ–º–Ω–∏—Ç–µ–ª—å–Ω–æ",
        "–ù–µ –¥—É–º–∞—é, —á—Ç–æ —ç—Ç–æ —Ö–æ—Ä–æ—à–∞—è –∏–¥–µ—è",
        "–°–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä—É–π—Å—è –∏ —Å–ø—Ä–æ—Å–∏ –æ–ø—è—Ç—å",
    ]
    bot.reply_to(message, f"üé± {random.choice(answers)}")


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –ª–∏—á–∫–µ –∏ –≥—Ä—É–ø–ø–∞—Ö
# @bot.message_handler(func=lambda message: True)
# def handle_message(message):
#     """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ª–∏—á–Ω—ã—Ö —á–∞—Ç–∞—Ö –∏ –≥—Ä—É–ø–ø–∞—Ö."""
    # –ó–¥–µ—Å—å 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π: –≤ –ª–∏—á–Ω—ã—Ö —á–∞—Ç–∞—Ö –∏ –≤ –≥—Ä—É–ø–ø–∞—Ö
    # –í –ø–µ—Ä–≤–æ–º —Å–ª—É—á–∞–µ –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –¢–û–õ–¨–ö–û –≤ –ª–∏—á–∫–µ
    # –í–æ –≤—Ç–æ—Ä–æ–º —Å–ª—É—á–∞–µ –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –¢–û–õ–¨–ö–û –≤ –≥—Ä—É–ø–ø–µ
    # if message.chat.type == "private":
    #     bot.reply_to(message, "–¢—ã –ø–∏—à–µ—à—å –º–Ω–µ –≤ –ª–∏—á–∫—É!")
    # elif message.chat.type in ["group", "supergroup"]:
    #     bot.reply_to(message, f"–°–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–µ: {message.text}")
    # –ß—Ç–æ –±—ã –æ–Ω–æ –Ω–∞—Å –Ω–µ –∑–∞–µ–±—ã–≤–∞–ª–æ —è –∑–∞–∫–æ–º–µ–Ω—Ç–∏–ª —á—Ç–æ –±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–¥ –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º


# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
bot.polling(none_stop=True)
